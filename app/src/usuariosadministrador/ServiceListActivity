import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.text.Editable
import android.text.TextWatcher
import android.view.View
import android.widget.LinearLayout
import android.widget.ProgressBar
import android.widget.Toast
import androidx.appcompat.app.AlertDialog
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import androidx.recyclerview.widget.LinearLayoutManager
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.appbar.MaterialToolbar
import com.google.android.material.floatingactionbutton.FloatingActionButton
import com.google.android.material.textfield.TextInputEditText
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch

class ServiceListActivity : AppCompatActivity() {

    private lateinit var recyclerView: RecyclerView
    private lateinit var progressBar: ProgressBar
    private lateinit var emptyStateLayout: LinearLayout
    private lateinit var etSearch: TextInputEditText
    private lateinit var fabAddService: FloatingActionButton
    private lateinit var serviceAdapter: ServiceAdapter

    companion object {
        const val REQUEST_CODE_CREATE = 1001
        const val REQUEST_CODE_EDIT = 1002
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_service_list)

        if (!isUserAdmin()) {
            Toast.makeText(this, "Acceso denegado. Solo administradores.", Toast.LENGTH_LONG).show()
            finish()
            return
        }

        initViews()
        setupRecyclerView()
        setupSearch()
        setupFAB()
        loadServices()
    }

    private fun initViews() {
        recyclerView = findViewById(R.id.recyclerViewServices)
        progressBar = findViewById(R.id.progressBar)
        emptyStateLayout = findViewById(R.id.emptyStateLayout)
        etSearch = findViewById(R.id.etSearch)
        fabAddService = findViewById(R.id.fabAddService)

        val toolbar = findViewById<MaterialToolbar>(R.id.toolbar)
        setSupportActionBar(toolbar)
        supportActionBar?.setDisplayHomeAsUpEnabled(true)
    }

    private fun setupRecyclerView() {
        serviceAdapter = ServiceAdapter(
            services = emptyList(),
            onEditClick = { service ->
                editService(service)
            },
            onDeleteClick = { service ->
                confirmDeleteService(service)
            },
            onActiveToggle = { service, isActive ->
                toggleServiceStatus(service, isActive)
            }
        )

        recyclerView.apply {
            layoutManager = LinearLayoutManager(this@ServiceListActivity)
            adapter = serviceAdapter
        }
    }

    private fun setupSearch() {
        etSearch.addTextChangedListener(object : TextWatcher {
            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}
            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}
            override fun afterTextChanged(s: Editable?) {
                serviceAdapter.filter(s.toString())
            }
        })
    }

    private fun setupFAB() {
        fabAddService.setOnClickListener {
            val intent = Intent(this, CreateEditServiceActivity::class.java)
            startActivityForResult(intent, REQUEST_CODE_CREATE)
        }
    }

    private fun loadServices() {
        showLoading(true)

        lifecycleScope.launch {
            delay(1000)

            val services = getDummyServices()

            serviceAdapter.updateServices(services)
            showLoading(false)

            if (services.isEmpty()) {
                emptyStateLayout.visibility = View.VISIBLE
                recyclerView.visibility = View.GONE
            } else {
                emptyStateLayout.visibility = View.GONE
                recyclerView.visibility = View.VISIBLE
            }
        }
    }

    private fun showLoading(show: Boolean) {
        progressBar.visibility = if (show) View.VISIBLE else View.GONE
        recyclerView.visibility = if (show) View.GONE else View.VISIBLE
    }

    private fun editService(service: Service) {
        val intent = Intent(this, CreateEditServiceActivity::class.java)
        intent.putExtra("service_id", service.id)
        intent.putExtra("service_name", service.name)
        intent.putExtra("service_description", service.description)
        intent.putExtra("service_category", service.category)
        intent.putExtra("service_price", service.price)
        intent.putExtra("service_duration", service.duration)
        intent.putExtra("service_image_url", service.imageUrl)
        intent.putExtra("service_is_active", service.isActive)

        startActivityForResult(intent, REQUEST_CODE_EDIT)
    }

    private fun confirmDeleteService(service: Service) {
        AlertDialog.Builder(this)
            .setTitle("Eliminar Servicio")
            .setMessage("¿Estás seguro de que deseas eliminar '${service.name}'?")
            .setPositiveButton("Eliminar") { _, _ ->
                deleteService(service)
            }
            .setNegativeButton("Cancelar", null)
            .show()
    }

    private fun deleteService(service: Service) {
        lifecycleScope.launch {
            Toast.makeText(
                this@ServiceListActivity,
                "Servicio eliminado: ${service.name}",
                Toast.LENGTH_SHORT
            ).show()

            loadServices()
        }
    }

    private fun toggleServiceStatus(service: Service, isActive: Boolean) {
        lifecycleScope.launch {
            val status = if (isActive) "activado" else "desactivado"
            Toast.makeText(
                this@ServiceListActivity,
                "Servicio $status: ${service.name}",
                Toast.LENGTH_SHORT
            ).show()
        }
    }

    private fun isUserAdmin(): Boolean {
        val sharedPref = getSharedPreferences("user_prefs", Context.MODE_PRIVATE)
        return sharedPref.getString("user_role", "") == "ADMIN"
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if (resultCode == RESULT_OK) {
            loadServices()
        }
    }

    private fun getDummyServices(): List<Service> {
        return listOf(
            Service(
                id = "1",
                name = "Lavado de Alfombras",
                description = "Limpieza profunda de alfombras con máquinas especializadas",
                price = 15990.0,
                category = "Limpieza",
                duration = 120,
                isActive = true
            ),
            Service(
                id = "2",
                name = "Poda de Jardín",
                description = "Servicio de poda y mantención de áreas verdes",
                price = 25000.0,
                category = "Jardinería",
                duration = 180,
                isActive = true
            ),
            Service(
                id = "3",
                name = "Pintura de Interiores",
                description = "Pintura profesional de espacios interiores",
                price = 45000.0,
                category = "Pintura",
                duration = 480,
                isActive = false
            )
        )
    }

    override fun onSupportNavigateUp(): Boolean {
        onBackPressed()
        return true
    }
}
